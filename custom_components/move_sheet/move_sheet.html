<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">

<link rel="import" href="../behaviors/gif_behavior.html">
<link rel="import" href="../smash_card_content/smash_card_content.html">
<link rel="import" href="../frame_scrubber/frame_scrubber.html">
<link rel="import" href="../input_builder/input_builder.html">

<script type="text/javascript" src="../../js/libgif-js/libgif.js"></script>

<dom-module id="move-sheet">
    <template>
        <style>
            paper-card {
                width: 100%;
            }

            #move_name {
                font-size: 24px;
                border-bottom: 1px solid rgb(229, 229, 229);
                padding-top: 9px;
            }

            span {
                width: 100%;
                display: block;
            }

            .category_header {
                font-weight: bold;
            }

            .jsgif canvas{
                width: 100%;
            }
        </style>
        <paper-card id="move_card">
            <div id="gif_container"></div>
            <div id="move_name" class="card-content">[[ move.name ]]</div>
            <smash-card-content id="frame_scrubber_card_content" class="card-content" name="Scrubber" add_bottom_border>
                <frame-scrubber id="frame_scrubber" slot="collapse_content" class="collapse-content card-content" total_frames="[[ total_frames ]]" current_frame="{{ current_frame }}"></frame-scrubber>
            </smash-card-content>
            <smash-card-content class="card-content" name="Inputs" add_bottom_border>
                <input-builder slot="collapse_content" class="collapse-content card-content" inputs="{{ move.input }}"></input-builder>
            </smash-card-content>
            <smash-card-content class="card-content" name="Details">
                <template is="dom-repeat" items="[[ get_hitbox_categories(move) ]]" as="category">
                    <div slot="collapse_content" class="category_header">[[ to_display_name(category) ]]</div>
                    <div slot="collapse_content">
                        <span>Damage: [[ get_all_stats(category, 'dmg') ]]</span>
                        <span>Angle: [[ get_all_stats(category, 'angle') ]]</span>
                        <span>Base Knockback: [[ get_all_stats(category, 'bk') ]]</span>
                        <span>Set Knockback: [[ get_all_stats(category, 'wbk') ]]</span>
                        <span>Knockback Growth: [[ get_all_stats(category, 'kg') ]]</span>
                        <span>Effect: [[ get_all_stats(category, 'effect') ]]</span>
                    </div>
                    <br slot="collapse_content"/>
                </template>
            </smash-card-content>
        </paper-card>
    </template>
    <script>
        Polymer({
            is: 'move-sheet',

            behaviors: [
                GifBehavior
            ],

            properties: {
                move: {
                   type: Object,
                   value: {},
                   observer: 'move_changed'
                },
                total_frames: {
                   type: Number,
                   value: -1
                },
                current_frame: {
                    type: Number,
                    value: -1
                }
            },

            listeners: {
                'current_frame_changed': 'current_frame_changed',
                'play_pause_tapped': 'play_pause_tapped',
            },

            ready: function() {
            },

            move_changed: function() {
                this.current_gif = undefined;
                this.clean_up_container(this.$.gif_container);
                this.get_gif(this.move.character, this.move, this.$.gif_container).then(function(gif) {
                    this.current_gif = gif;
                    gif.load(function() {
                        gif.play()
                        this.total_frames = gif.get_length();
                        gif.get_canvas().addEventListener('click', this.play_pause_tapped.bind(this));
                        setInterval(function() {
                            if(gif.get_playing()) {
                                this.$.frame_scrubber.current_frame = gif.get_current_frame();
                            }
                        }.bind(this), 50)
                    }.bind(this));
                }.bind(this));
            },

            set_move_name: function() {
                this.$.move_name.innerHTML =  this.move.name;
                if(this.move.name.lastIndexOf('B') == this.move.name.length - 1) {
                    var moves_to_index = {
                        'Neutral B': 0,
                        'Forward B': 1,
                        'Up B': 2,
                        'Down B': 3
                    }
                    var display_name = this.move.b_moves[moves_to_index[this.move.name]];
                    this.$.move_name.innerHTML = display_name + ' - ' + this.move.name;
                }
            },

            to_display_name: function(name) {
                name = name.replace(/\w\S*/g, function(txt){
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                });
                name = name.replace(/\d/g, function(txt) {
                    return ' ' + txt;
                });
                if(name.indexOf('_') != -1) {
                    name = name.replace('_', ' ');
                }
                if(name.indexOf('id') != -1) {
                    name = name.replace('^(id)', 'ID');
                }
                return name;
            },

            get_hitbox_categories: function() {
                if(this.move) {
                    return Object.keys(this.move.hitboxes);
                }
            },

            get_all_stats: function(category, type) {
                var arr = [];
                if(!this.move.hitboxes[category][Object.keys(this.move.hitboxes[category])[0]].dmg) {
                    arr.push(this.move.hitboxes[category][type])
                }
                else {
                    for(var i in this.move.hitboxes[category]) {
                        arr.push(this.move.hitboxes[category][i][type])
                    }
                }
                var all_equal = true;
                var first_elem = arr[0];
                for(var j in arr) {
                    if(arr[j] != arr[0]) {
                        all_equal = false;
                    }
                }
                if(all_equal) {
                    return arr[0];
                }
                return arr.join(', ');
            },

            current_frame_changed: function(event) {
                if(this.current_gif) {
                    this.current_gif.pause();
                    this.current_gif.move_to(event.detail);
                }
            },

            play_pause_tapped: function() {
                this.play_pause_toggle(this.$.frame_scrubber, this.current_gif);
            }
        });
    </script>
</dom-module>